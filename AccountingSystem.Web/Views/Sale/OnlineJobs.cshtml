@{
    ViewData["Title"] = "OnlineJobs";
}
<style>
    .selected-row {
        border: 2px solid black !important;
    }

    .selected-row td {
        padding: 8px !important;
    }

    .selected-job-row {
        border: 2px solid #007bff;
    }

    .selected-job-row td {
        padding: 8px;
    }
</style>
<h3 class="text-center alert-primary" style="margin-top:-10px">OnlineJobs</h3>

<div ng-app="myApp">
    <div ng-controller="myController">
        <div class="col-sm-12">
            <div class="row" style="margin-top:-15px">
                <div class="col-sm-7">
                    <div class="row">
                        <div class="col-sm-3">
                            <label class="col-form-label">From</label>
                            <input type="date" class="form-control form-control-sm" ng-model="from" />
                        </div>
                        <div class="col-sm-3">
                            <label class="col-form-label">To</label>
                            <input type="date" class="form-control form-control-sm" ng-model="to" />
                        </div>
                        <div class="col-sm-3 text-center mt-5">
                            <label><input type="checkbox" ng-model="PNPL" /> PNPL</label>
                        </div>
                        <div class="col-sm-3">
                            <button class="btn btn-info btn-sm mt-5" ng-click="download()">Download Jobs</button>
                        </div>
                    </div>
                    <div class="row" style="margin-top:-10px">
                        <div class="col-sm-3">
                            <label>Search By Companies</label>
                            <input type="text" class="form-control form-control-sm" ng-model="cname" />
                        </div>
                        <div class="col-sm-3">
                            <label>Search By Service</label>
                            <select type="text" class="form-control form-control-sm" ng-model="service">
                                <option value="0">Select</option>
                                <option ng-repeat="o in services" value="{{o.serviceId}}" data-ledgerid="{{o.ledgerId}}">{{o.serviceName}}</option>
                            </select>
                        </div>
                        <div class="col-sm-3 text-center mt-4">
                            <label><input type="checkbox" ng-model="verified" /> Varified</label>
                        </div>
                        <div class="col-sm-3 mt-4">
                            <button class="btn btn-primary btn-sm" ng-click="search()" style="padding-left:45px;padding-right:45px">GO</button>
                        </div>
                    </div>
                </div>
                <div class="col-sm-5 mt-3">
                    <button class="btn btn-info btn-sm float-right" ng-click="">Company Varification</button>
                    <div class="float-right">
                        <label class="control-label float-right" style="font-weight: normal;">Paid Online</label>
                        <span style="border: 1px solid gray; background: #FFE6A8; height: 15px; width: 15px; margin: 8px 5px; " class="float-right"></span>
                        <label class="control-label float-right" style="font-weight: normal;">Standout</label>
                        <span style="border: 1px solid gray; background: #C5C69D; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span>
                        <label class="control-label float-right" style="font-weight: normal;">Regional</label>
                        <span style="border: 1px solid gray; background: #F3CCFF; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span>
                        <label class="control-label float-right" style="font-weight: normal;">Blue Collar</label>
                        <span style="border: 1px solid gray; background: #0BB5FF; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span>
                        <label class="control-label float-right" style="font-weight: normal;">Verified</label>
                        <span style="border: 1px solid gray; background: #9C27B0; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span><br />
                        <label class="control-label float-right" style="font-weight: normal;">Premium</label>
                        <span style="border: 1px solid gray; background: #D5F5E3; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span>
                        <label class="control-label float-right" style="font-weight: normal;">Uddokta</label>
                        <span style="border: 1px solid gray; background: #fa6e66; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span>
                        <label class="control-label float-right" style="font-weight: normal;">LN</label>
                        <span style="border: 1px solid gray; background: #0CFBFF; height: 15px; width: 15px; margin: 8px 5px;" class="float-right"></span>
                    </div>
                </div>
            </div>
            <center>
                <button class="btn btn-primary" type="button" disabled ng-show="spinner">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                </button>
            </center>
            <div class="row mt-2" style="height: 200px; overflow-y: auto;border:1px solid darkgray">
                <table class="table table-bordered table-hover table-sm" style="white-space:nowrap;">
                    <thead class="thead-light">
                        <tr>
                            <th class="border">Sl#</th>
                            <th class="border">CP Id</th>
                            <th class="border acenter">Name Of Company</th>
                            <th class="border">Job Posted</th>
                            <th class="border">Total Job Posted</th>
                            <th class="border">Company Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="o in companyData" ng-style="getRowStyle(o)" ng-click="selectRow(o)" ng-class="{ 'selected-row': o === selectedRow }">
                            <td class="border">{{$index + 1}}</td>
                            <td class="border">{{o.cP_ID}}</td>
                            <td class="border">{{o.cName}}</td>
                            <td class="border">{{o.jobPosted}}</td>
                            <td class="border">{{o.totalJobPosted}}</td>
                            <td class="border">{{o.companyStatus}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
        <div class="row mt-2">
            <div class="col-sm-7">
                <label class="fw-bold">Job titles of</label>
            </div>
            <div class="col-sm-5">
                <div class="form-group row">
                    <label class="col-sm-5 table-hover fw-bold">Invoices to Upload</label>
                    <div class="col-sm-6">
                        <select class="form-control form-control-sm" ng-model="invoice">
                            <option value="0">Select</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-7" style="height: 150px; overflow-y: auto; margin-top:-10px;">
                <table class="table table-bordered table-hover table-sm" style="white-space:nowrap;">
                    <thead class="thead-light">
                        <tr>
                            <th>Sl#</th>
                            <th class="acenter">Job title</th>
                            <th>Type</th>
                            <th>Posted</th>
                            <th>ValidDate</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="o in jobData" ng-click="selectJob(o)" ng-class="{ 'selected-row': o === selectedJob }">
                            <td>{{$index+1}}</td>
                            <td>{{o.title}}</td>
                            <td>{{o.addType}}</td>
                            <td>{{o.postingDate}}</td>
                            <td>{{o.validDate}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-sm-5 row ml-2" style="height: 150px; overflow-y: auto;margin-top:-10px;">
                <table class="table table-bordered table-sm" style="white-space:nowrap;">
                    <thead class="thead-light">
                        <tr>
                            <th class="acenter">Sl#</th>
                            <th class="acenter">Invoice No</th>
                            <th class="acenter">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="o in invoiceData">
                            <td>{{$index+1}}</td>
                            <td>{{}}</td>
                            <td>{{}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>


        <div class="col-sm-12 mt-2">
            <div class="row">
                <div class="col-sm-4">
                    <div class="form-group row">
                        <label class="col-sm-4">Invoice No</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm" ng-model="invoiceNo" />
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group row">
                        <label class="col-sm-4">Billing To</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm" ng-model="billingTo" />
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group row">
                        <label class="col-sm-4">Invoice Price</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm" ng-model="invoicePrice" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-12">
            <div class="row" style=" margin-top: 10px; margin-bottom: 10px; padding-left: 0;padding-right: 0;">
                <div class="col-sm-3">
                    <button class="btn btn-primary btn-sm" ng-click="refresh()" style="padding-left:45px;padding-right:45px">Refresh</button>
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary btn-sm" ng-click="makeSale()" style="padding-left:45px;padding-right:45px" ng-disabled="!makeBtn">Make Sale</button>
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary btn-sm" ng-click="delete()" style="padding-left:45px;padding-right:45px" ng-disabled="!deleteBtn">Delete</button>
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary btn-sm" ng-click="uploadInvoice()" style="padding-left:45px;padding-right:45px" ng-disabled="!uploadBtn">Upload Invoice</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.9/angular.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script>
    var app = angular.module('myApp', []);
    app.controller('myController', function ($scope, $http) {
        angular.element(document).ready(function () {
            $scope.spinner = false;
            $scope.service = '0';
            $scope.loadServices();
        })
        $scope.from = new Date();
        $scope.to = new Date();

        $scope.getRowStyle = function (o) {
            var rowStyle = {};
            if (o.verifiedCompany === "Verified" && !$scope.verified) {
                rowStyle = {
                    "font-weight": "bold",
                    "color": "#9C27B0"
                };
            }
            if (o.opid > 0 || o.addType > 0 || o.region > 0) {
                if (o.addType == 1) {
                    rowStyle["background"] = "#C5C69D"; // Stand-out
                }
                else if (o.region > 0) {
                    rowStyle["background"] = "#F3CCFF"; // Regional
                }
                else if (o.addType == 2) {
                    rowStyle["background"] = "#D5F5E3"; // Premium
                } else if (o.addType == 11) {
                    rowStyle["background"] = "#0CFBFF"; // Only LN
                } else if (o.opid > 0) {
                    rowStyle["background"] = "#FFE6A8"; // Paid Online

                } else if (o.addType == 10) {
                    rowStyle["background"] = "#fa6e66"; // Uddokta
                }
            }

            return rowStyle;
        };

        $scope.loadServices = function () {
            $http.get('/Ledger/GetService', { params: { sTypy: 1 } })
                .then(function (response) {
                    $scope.services = response.data;
                }, function (error) {
                    console.error(error);
                })
        }

        $scope.download = function () {
            $scope.spinner = true;
            var fromDate = $scope.from;
            var toDate = $scope.to;
            var PNPL = $scope.PNPL ? 1 : 0;

            $http.get('/Sale/DownLoadOnlineJobs', { params: { fromDate: fromDate, toDate: toDate, PNPL: PNPL } })
                .then(function (response) {
                    $("#companyDiv").show();
                    var errorText = "";
                    if (parseInt(response.data) == 1) {
                        errorText = "You made some invoices which had not uploaded. You must upload those Invoices, then you can download new jobs.<br/>To upload invoices, click the '<strong>Refresh</strong>' button. Then find the jobs which has invoice number.<br/>After getting the invoice number, click the '<strong>Send Invoice number to Online</strong>' button.";
                    } else if (parseInt(response.data) == 2 || parseInt(response.data) == 3) {
                        errorText = "An Online Connection Error has been occured";
                    } else {
                        $scope.refreshData();
                    }
                    if (errorText !== "") {
                        alert("Error:\n\n" + errorText);
                    }
                    $scope.spinner = false;
                }, function (error) {
                    console.error(error);
                    alert('No data found');
                    $scope.spinner = false;
                })
        }

        $scope.companyData = [];
        $scope.jobData = [];

        $scope.refreshData = function () {
            $scope.spinner = true;
            var selectedService = $scope.services.find(function (s) {
                return s.serviceId == $scope.service;
            });

            var LedgerID = selectedService ? selectedService.ledgerId : 0;
            var CName = $scope.cname == "" || $scope.cname == undefined ? "" : $scope.cname;
            var Verified = $scope.verified == "" || $scope.verified == undefined ? 0 : $scope.verified;

            $http.get('/Sale/GetOnlineJobList', { params: { CName: CName, Verified: Verified, LedgerID: LedgerID } })
                .then(function (response) {
                    $scope.companyData = response.data;
                    $scope.spinner = false;
                }, function (error) {
                    console.error(error);
                    alert('Error fetching data');
                    $scope.spinner = false;
                })
        };

        $scope.showJobData = function (cpId, date, adType, adRegion) {
            $http.get('/Sale/GetJobs', { params: { cpId: cpId, date: date, adType: adType, adRegion: adRegion } })
                .then(function (response) {
                    debugger
                    $scope.jobData = response.data;
                }, function (error) {
                    console.error(error);
                    alert('Error fetching job data');
                });
        };

        $scope.selectedRow = null;
        $scope.selectRow = function (row) {
            if ($scope.selectedRow === row) {
                // If the same row is clicked again, deselect it
                $scope.selectedRow = null;
            } else {
                $scope.selectedRow = row;
                // Call your showJobData function or perform other actions here
                $scope.showJobData(row.cP_ID, row.postingDate, row.addType, row.region);
            }
        };

        $scope.selectJob = null;
        $scope.selectJob = function (job) {
            if ($scope.selectedJob === job) {
                // If the same job is clicked again, deselect it
                $scope.selectedJob = null;
            } else {
                $scope.selectedJob = job;
                // Call your showbutton function or perform other actions here
                $scope.showbutton();

            }
        };

        $scope.showbutton = function () {
            if ($scope.selectedJob) {
                $scope.makeBtn = true;
                $scope.deleteBtn = true;
                $scope.uploadBtn = true;
            } else {
                $scope.makeBtn = false;
                $scope.deleteBtn = false;
                $scope.uploadBtn = false;
            }
        };

        $scope.search = function () {
            $scope.refreshData();
            $scope.showJobData()
        }

        $scope.refresh = function () {
            $scope.refreshData();
            $scope.showJobData();
        }


        $scope.delete = function () {
            debugger
            var confirmDelete = window.confirm('Are you sure to delete the selected job?');

            if (confirmDelete) {
                var jpId = $scope.selectedJob.jp_Id; // Adjust this based on your data structure
                $http.get('/Sale/DeleteOnlineJob', { params: { jpId: jpId } })
                    .then(function (response) {
                        if (response.data === true) {
                            alert("Delete operation completed successfully.");
                            //$scope.jobData.splice($scope.jobData.indexOf($scope.selectedJob), 1);
                            $scope.removeSelectedJobAndUpdateRows();
                        }
                    })
                    .catch(function (error) {
                        console.error('Error deleting job:', error);
                        alert('An error occurred while deleting the job. Please try again later.');
                    });
            }
        };
        $scope.removeSelectedJobAndUpdateRows = function () {
            var selectedJobIndex = $scope.jobData.findIndex(function (job) {
                return job === $scope.selectedJob;
            });

            if (selectedJobIndex !== -1) {
                $scope.jobData.splice(selectedJobIndex, 1);

                if ($scope.jobData.length === 0) {
                    // If jobData is empty, remove the corresponding company row
                    $scope.removeSelectedCompany();
                } else {
                    // Update row numbers
                    var cnt = 0;
                    angular.forEach($scope.jobData, function (job, index) {
                        if (job.title !== "") {
                            cnt++;
                            job.$index = cnt;
                        }
                    });
                }
            }
        };

        // Function to remove selected company
        $scope.removeSelectedCompany = function () {
            var selectedCompanyIndex = $scope.companyData.findIndex(function (company) {
                return company === $scope.selectedRow;
            });

            if (selectedCompanyIndex !== -1) {
                $scope.companyData.splice(selectedCompanyIndex, 1);
            }
        };

    })
</script>



